# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

#### `/rag/add-document` (–æ–¥–∏–Ω–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `process_document_task.delay()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ Celery
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `task_id` —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ù–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤ —Ç–∏–ø–∞ `.get()` –∏–ª–∏ `.result`
- ‚úÖ –§–∞–π–ª —á–∏—Ç–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–¥–∞—á—É

**–ö–æ–¥:**
```python
# main.py:274
task = process_document_task.delay(
    file_path=None,
    file_content=content,
    filename=file.filename,
    metadata={"filename": file.filename, "uploaded_at": "now"}
)
return {
    "status": "queued",
    "task_id": task.id,  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É
    ...
}
```

#### `/rag/add-documents-batch` (–ø–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `process_document_task.delay()` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ `task_id` —Å—Ä–∞–∑—É
- ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

**–ö–æ–¥:**
```python
# main.py:357
for file in files:
    content = await file.read()
    task = process_document_task.delay(...)  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    individual_tasks.append({
        "task_id": task.id,
        "filename": file.filename
    })
```

### 2. Celery –∑–∞–¥–∞—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

#### `process_document_task`
- ‚úÖ –î–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞–∫ `@celery_app.task`
- ‚úÖ –ò–º–µ–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ retry –∏ timeout
- ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º –≤–æ—Ä–∫–µ—Ä–µ
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏ –∑–∞–¥–∞—á–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
@celery_app.task(
    name="core.tasks.process_document",
    bind=True,
    max_retries=3,
    default_retry_delay=60,
    soft_time_limit=240,  # 4 minutes
    time_limit=300  # 5 minutes
)
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á

#### `/rag/task/{task_id}`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `celery_app.AsyncResult(task_id)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ `task.result` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

### 4. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
API Request ‚Üí FastAPI Endpoint
    ‚Üì
    .delay() ‚Üí Celery Queue (Redis)
    ‚Üì
    Return task_id immediately ‚úÖ
    
    (–í —Ñ–æ–Ω–µ)
    Celery Worker ‚Üí process_document_task
        ‚Üì
        RAGService.add_document()
        ‚Üì
        DocumentProcessor.process_document()
        ‚Üì
        Vector Store (Qdrant/ChromaDB)
```

## üîç –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–º—è—Ç—å
**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
content = await file.read()  # –ß–∏—Ç–∞–µ—Ç –≤–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å
task = process_document_task.delay(file_content=content, ...)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—É—Ç—å:
```python
import tempfile
temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=ext)
temp_file.write(await file.read())
temp_file.close()
task = process_document_task.delay(file_path=temp_file.name, ...)
```

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** ‚úÖ –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `process_document_task` - —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ –∑–∞–¥–∞—á–∏.

### 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –ó–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ Celery worker pool.

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `test_async_upload.py`:

```bash
python test_async_upload.py
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç API (< 1 —Å–µ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞)
2. ‚úÖ –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç task_id —Å—Ä–∞–∑—É
3. ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. ‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ `/rag/task/{task_id}`

## ‚úÖ –í—ã–≤–æ–¥—ã

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ:**

1. ‚úÖ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É (–Ω–µ –∂–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏)
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Celery –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. ‚úÖ –ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ
4. ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ task_id
5. ‚úÖ –ù–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –≤—ã–∑–æ–≤–æ–≤ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Celery worker –∑–∞–ø—É—â–µ–Ω: `celery -A core.celery_app worker --loglevel=info`
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Redis –¥–æ—Å—Ç—É–ø–µ–Ω: `redis-cli ping`
- ‚úÖ –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤: `--concurrency=4`

## üöÄ –ó–∞–ø—É—Å–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Redis:
```bash
docker-compose up -d redis
# –∏–ª–∏
redis-server
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Celery worker:
```bash
celery -A core.celery_app worker --loglevel=info --concurrency=4
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ API —Å–µ—Ä–≤–µ—Ä:
```bash
uvicorn main:app --reload
```

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç:
```bash
python test_async_upload.py
```

