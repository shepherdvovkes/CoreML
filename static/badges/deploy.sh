#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ lexapp.co.ua
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh [user@]hostname [remote_path]

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
REMOTE_HOST="${1:-user@lexapp.co.ua}"
REMOTE_PATH="${2:-/var/www/lexapp.co.ua/badges}"

echo -e "${GREEN}üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ ${REMOTE_HOST}${NC}"
echo -e "${YELLOW}–£–¥–∞–ª–µ–Ω–Ω—ã–π –ø—É—Ç—å: ${REMOTE_PATH}${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ ! -d "$SCRIPT_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
ssh "$REMOTE_HOST" "mkdir -p $REMOTE_PATH"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
rsync -avz --progress \
    "$SCRIPT_DIR/" \
    "$REMOTE_HOST:$REMOTE_PATH/"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
ssh "$REMOTE_HOST" "chmod -R 755 $REMOTE_PATH && chown -R www-data:www-data $REMOTE_PATH 2>/dev/null || chmod -R 755 $REMOTE_PATH"

echo ""
echo -e "${GREEN}‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ nginx –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ $REMOTE_PATH"
echo "2. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –≤ index.html –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –≤–∞—à–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: https://lexapp.co.ua/badges/index.html"
echo ""
echo "–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx:"
echo "---"
echo "location /badges {"
echo "    alias $REMOTE_PATH;"
echo "    try_files \$uri \$uri/ =404;"
echo "}"
echo "---"
