# Безопасность CoreML

## Автоматическая генерация паролей

При развертывании автоматически генерируются безопасные пароли для:

1. **Redis** - пароль для защиты доступа к кэшу и Celery broker
2. **Qdrant** - API ключ для защиты векторной БД

## Генерация секретов

### Автоматическая генерация (при развертывании)

```bash
./scripts/deploy.sh prod
```

Скрипт автоматически:
- Создает `.env` из `.env.example` (если не существует)
- Генерирует безопасные пароли для Redis и Qdrant
- Обновляет все URL с паролями
- Устанавливает безопасные права доступа (600)

### Ручная генерация

```bash
# Генерация секретов
./scripts/generate_secrets.sh .env

# Проверка безопасности
./scripts/check_secrets.sh .env
```

## Проверка безопасности

Перед развертыванием рекомендуется проверить секреты:

```bash
./scripts/check_secrets.sh .env
```

Скрипт проверяет:
- ✅ Наличие и длину паролей
- ✅ Соответствие паролей в URL
- ✅ Права доступа к файлу .env

## Безопасность файла .env

**ВАЖНО:** Файл `.env` содержит секретные ключи!

### Рекомендации:

1. **Права доступа:**
   ```bash
   chmod 600 .env
   ```

2. **Не коммитить в git:**
   - Файл `.env` должен быть в `.gitignore`
   - Используйте `.env.example` для шаблона

3. **Резервное копирование:**
   - Храните `.env` в безопасном месте
   - Используйте secrets management (Vault, AWS Secrets Manager)

4. **Ротация паролей:**
   ```bash
   # Удалите старые пароли из .env
   # Затем запустите генерацию заново
   ./scripts/generate_secrets.sh .env
   ```

## Использование паролей в контейнерах

### Redis

Пароль Redis автоматически используется в:
- `REDIS_URL` - для кэширования
- `CELERY_BROKER_URL` - для Celery broker
- `CELERY_RESULT_BACKEND` - для результатов Celery

Формат URL: `redis://:PASSWORD@host:port/db`

### Qdrant

API ключ Qdrant передается через:
- `QDRANT_API_KEY` - переменная окружения
- Используется в `QdrantClient` для аутентификации

## Production рекомендации

1. **Используйте внешний secrets management:**
   - HashiCorp Vault
   - AWS Secrets Manager
   - Kubernetes Secrets

2. **Ограничьте доступ к портам:**
   - Redis (6379) - только внутри Docker network
   - Qdrant (6333-6334) - только внутри Docker network
   - API (8000) - через reverse proxy с SSL

3. **Мониторинг:**
   - Логируйте попытки доступа
   - Настройте алерты на подозрительную активность

4. **Регулярная ротация:**
   - Меняйте пароли каждые 90 дней
   - Используйте скрипт `generate_secrets.sh` для генерации новых

## Восстановление после потери паролей

Если пароли потеряны:

1. Остановите контейнеры:
   ```bash
   docker-compose -f docker-compose.prod.yml down
   ```

2. Сгенерируйте новые пароли:
   ```bash
   ./scripts/generate_secrets.sh .env
   ```

3. Обновите конфигурацию и перезапустите:
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

**Примечание:** При смене пароля Redis потребуется перезапуск всех сервисов, использующих Redis.

