# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Celery + Redis –∏ HTTP –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. Celery + Redis –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

#### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **`core/celery_app.py`**: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è production
- **`core/tasks.py`**: –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏:
  - `process_document_task`: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  - `process_documents_batch_task`: –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - `health_check_task`: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤–æ—Ä–∫–µ—Ä–æ–≤

#### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **`main.py`**: 
  - Endpoint `/rag/add-document` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Celery (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
  - –ù–æ–≤—ã–π endpoint `/rag/task/{task_id}` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á
  - –ù–æ–≤—ã–π endpoint `/rag/add-documents-batch` –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

- **`config.py`**: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Celery –∏ Redis

- **`requirements.txt`**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
  - `celery==5.3.4`
  - `redis==5.0.1`
  - `flower==2.0.1` (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

#### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

- **`docker-compose.yml`**: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Redis –∏ Flower
- **`scripts/start_celery_worker.sh`**: –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –≤–æ—Ä–∫–µ—Ä–∞
- **`scripts/start_flower.sh`**: –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ Flower

### 2. HTTP –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è

#### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **`core/services/http_client.py`**: HTTP –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏:
  - `ServiceHTTPClient`: –ë–∞–∑–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —Å retry –ª–æ–≥–∏–∫–æ–π
  - `RAGServiceClient`: –ö–ª–∏–µ–Ω—Ç –¥–ª—è RAG —Å–µ—Ä–≤–∏—Å–∞
  - `EmbeddingServiceClient`: –ö–ª–∏–µ–Ω—Ç –¥–ª—è Embedding —Å–µ—Ä–≤–∏—Å–∞

#### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å exponential backoff
- ‚úÖ Timeout –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ Health check –º–µ—Ç–æ–¥—ã
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞—Ç—á–∏–Ω–≥–∞

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
```
API Server ‚Üí RAG Service (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –±–ª–æ–∫–∏—Ä—É–µ—Ç API)
```

### –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
```
API Server ‚Üí Celery Task Queue (Redis) ‚Üí Celery Worker ‚Üí RAG Service
                ‚Üì
         GET /rag/task/{task_id} ‚Üê Redis (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å–∫ Redis
```bash
docker-compose up -d redis
# –∏–ª–∏
redis-server
```

### 2. –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞
```bash
python main.py
```

### 3. –ó–∞–ø—É—Å–∫ Celery Worker
```bash
celery -A core.celery_app worker --loglevel=info --concurrency=4
```

### 4. –ó–∞–ø—É—Å–∫ Flower (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
```bash
celery -A core.celery_app flower --port=5555
```

### 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ):
```bash
curl -X POST http://localhost:8000/rag/add-document \
  -F "file=@document.pdf"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "queued",
  "task_id": "abc123-def456-...",
  "message": "Document queued for processing",
  "check_status_url": "/rag/task/abc123-def456-..."
}
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
curl http://localhost:8000/rag/task/abc123-def456-...
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`:
```env
# Celery
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0

# Redis
REDIS_URL=redis://localhost:6379/0
REDIS_CACHE_TTL=3600
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `config.py`:
- `celery_task_time_limit`: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)
- `celery_task_soft_time_limit`: 240 —Å–µ–∫—É–Ω–¥ (4 –º–∏–Ω—É—Ç—ã)
- `celery_max_retries`: 3 –ø–æ–ø—ã—Ç–∫–∏
- `celery_default_retry_delay`: 60 —Å–µ–∫—É–Ω–¥

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ API –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á –≤ Redis
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Flower

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:
- ‚úÖ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—á–µ—Ä–µ–¥–∏ (high/low priority)
- ‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Flower Dashboard:
- URL: http://localhost:5555
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
  - –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
  - –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
  - –í–æ—Ä–∫–µ—Ä—ã –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Redis CLI:
```bash
redis-cli
> KEYS celery*
> GET celery-task-meta-{task_id}
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–°–º. —Ñ–∞–π–ª—ã:
- `examples/celery_usage.py`: –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API
- `DEPLOYMENT.md`: –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: Celery + Redis –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: HTTP –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
3. üîÑ –°–ª–µ–¥—É—é—â–µ–µ: –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Redis
4. üîÑ –°–ª–µ–¥—É—é—â–µ–µ: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ QueryRouter
5. üîÑ –°–ª–µ–¥—É—é—â–µ–µ: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **README.md**: –û–±–Ω–æ–≤–ª–µ–Ω —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ Celery
- **DEPLOYMENT.md**: –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- **ARCHITECTURE_REVIEW.md**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑



