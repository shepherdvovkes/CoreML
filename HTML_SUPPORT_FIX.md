# Исправление поддержки HTML файлов

## Проблема
HTML файлы показывают ошибки (красные иконки) при загрузке в Flutter приложение.

## Решение

### 1. Изменения в коде (уже применены)
- ✅ Добавлены `'html'` и `'htm'` в `AppConfig.supportedFileTypes` в `flutter_app/lib/utils/config.dart`
- ✅ Обновлена документация в `flutter_app/README.md`

### 2. Что нужно сделать

#### Шаг 1: Перезапустите Flutter приложение
**Важно**: После изменений в `config.dart` необходимо полностью перезапустить приложение:

```bash
cd flutter_app
# Остановите приложение (если запущено)
# Затем запустите заново:
flutter run -d macos
```

Или выполните **Hot Restart** (не Hot Reload):
- В VS Code/Android Studio: нажмите `Ctrl+Shift+F5` (или `Cmd+Shift+F5` на Mac)
- Или остановите и запустите приложение заново

**Причина**: `AppConfig.supportedFileTypes` - это константа, которая компилируется во время сборки. Hot Reload не обновляет константы.

#### Шаг 2: Очистите кэш (если проблема сохраняется)
```bash
cd flutter_app
flutter clean
flutter pub get
flutter run -d macos
```

#### Шаг 3: Проверьте логи сервера
Если ошибки все еще появляются, проверьте логи сервера на наличие ошибок при обработке HTML:

```bash
# В терминале, где запущен сервер
# Или проверьте логи Celery worker
tail -f celery_worker.log
```

### 3. Проверка работы

После перезапуска приложения:
1. Попробуйте загрузить HTML файл
2. Файл должен пройти валидацию (не должно быть ошибки "неподдерживаемый формат")
3. Документ должен начать обрабатываться (статус "processing")

### 4. Если ошибки все еще появляются

#### Проверка на стороне сервера:
1. Убедитесь, что Celery worker запущен:
   ```bash
   celery -A core.celery_app worker --loglevel=info
   ```

2. Проверьте, что beautifulsoup4 установлен:
   ```bash
   pip list | grep beautifulsoup4
   ```
   Если нет, установите:
   ```bash
   pip install beautifulsoup4
   ```

3. Проверьте обработку HTML вручную:
   ```bash
   python test_html_extraction.py "путь/к/файлу.html"
   ```

#### Проверка на стороне клиента:
1. Откройте DevTools в Flutter:
   ```bash
   flutter run -d macos --verbose
   ```

2. Проверьте консоль на наличие ошибок валидации

3. Убедитесь, что файл действительно имеет расширение `.html` или `.htm`

### 5. Отладка

Если проблема сохраняется, проверьте:

1. **Расширение файла**: Убедитесь, что файл имеет расширение `.html` или `.htm` (не `.HTML` или другое)

2. **Валидация в коде**: Проверьте, что валидация проходит:
   ```dart
   // В chat_service.dart строка 333 и 434
   final extension = fileName.contains('.') 
       ? fileName.split('.').last.toLowerCase()
       : '';
   if (extension.isEmpty || !AppConfig.supportedFileTypes.contains(extension)) {
     // Ошибка валидации
   }
   ```

3. **Логи приложения**: Включите логирование и проверьте, какое расширение определяется для файла

## Статус

- ✅ Код обновлен
- ⏳ Требуется перезапуск приложения
- ⏳ Требуется тестирование

## Примечания

- Hot Reload не обновляет константы в Dart/Flutter
- Необходим полный перезапуск приложения или Hot Restart
- Если файлы уже были загружены с ошибками, их нужно удалить и загрузить заново

