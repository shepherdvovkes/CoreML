# Исправление ошибки 400 Bad Request от OpenAI API

## Проблема

При классификации запросов через OpenAI API возникала ошибка 400 Bad Request.

## Причины и исправления

### 1. ✅ Улучшено логирование
- Добавлено детальное логирование payload перед отправкой
- Логируется текст ошибки при 400
- Логируется модель, base_url, длина запроса

### 2. ✅ Упрощен промпт
- Убраны сложные инструкции на русском
- Используется более простой формат на английском
- Добавлены четкие примеры различения номеров дел и документов

### 3. ✅ Безопасная обработка запросов
- Экранирование специальных символов
- Ограничение длины запроса (300 символов)
- Проверка на пустые промпты

### 4. ✅ Fallback механизм
- При ошибке 400 автоматически используется regex классификация
- Система продолжает работать даже при недоступности OpenAI API

### 5. ✅ Проверка формата сообщений
- Проверка что content не None
- Валидация сообщений перед отправкой

## Текущая конфигурация

- **Модель**: `gpt-3.5-turbo` (стандартная, без версии)
- **Temperature**: `0.1` (низкая для стабильности)
- **Max tokens**: `200` (короткий ответ)
- **Длина запроса**: ограничена 300 символами

## Логирование

При ошибке 400 теперь логируется:
- Статус код ответа
- Текст ошибки (первые 1000 символов)
- Модель и base_url
- Длина запроса и промпта
- Preview сообщений

## Тестирование

Все тесты пройдены успешно:
- ✅ "Покажи текст дела 686/32982/23" → правильно классифицируется
- ✅ "договір" → правильно классифицируется
- ✅ "покажи документ 686" → правильно классифицируется (исправлено)
- ✅ "что такое договор" → правильно классифицируется

## Рекомендации

Если ошибка 400 все еще возникает:

1. Проверьте логи - теперь будет детальная информация
2. Проверьте API ключ OpenAI в настройках
3. Проверьте base_url (должен быть `https://api.openai.com/v1`)
4. Проверьте баланс OpenAI аккаунта
5. Система автоматически переключится на regex fallback

