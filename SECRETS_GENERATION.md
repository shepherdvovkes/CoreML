# Автоматическая генерация безопасных паролей

## Обзор

При развертывании CoreML автоматически генерируются безопасные пароли для всех сервисов, которые в них нуждаются.

## Генерируемые секреты

### 1. Redis Password
- **Длина:** 32 символа
- **Формат:** Base64 (буквы, цифры, спецсимволы)
- **Использование:** Защита доступа к Redis (кэш и Celery broker)

### 2. Qdrant API Key
- **Длина:** 64 символа (hex)
- **Формат:** Шестнадцатеричная строка
- **Использование:** Аутентификация в Qdrant векторной БД

## Автоматическая генерация

### При развертывании

Скрипт `deploy.sh` автоматически:
1. Проверяет наличие `.env` файла
2. Создает его из `.env.example` если не существует
3. Генерирует пароли для Redis и Qdrant
4. Обновляет все URL с паролями
5. Устанавливает безопасные права доступа (600)
6. Проверяет безопасность секретов

```bash
./scripts/deploy.sh prod
```

### Ручная генерация

Если нужно сгенерировать пароли вручную:

```bash
# Генерация секретов
./scripts/generate_secrets.sh .env

# Проверка безопасности
./scripts/check_secrets.sh .env
```

## Обновление URL

После генерации паролей автоматически обновляются:

- `REDIS_URL` → `redis://:PASSWORD@redis:6379/0`
- `CELERY_BROKER_URL` → `redis://:PASSWORD@redis:6379/0`
- `CELERY_RESULT_BACKEND` → `redis://:PASSWORD@redis:6379/0`

## Использование в контейнерах

### Redis

Пароль передается через:
- Переменную окружения `REDIS_PASSWORD`
- URL в формате `redis://:PASSWORD@host:port/db`

Контейнер Redis запускается с флагом `--requirepass PASSWORD`

### Qdrant

API ключ передается через:
- Переменную окружения `QDRANT_API_KEY`
- Используется в `QdrantClient` для аутентификации

## Безопасность

### Права доступа

Файл `.env` автоматически получает права `600` (только владелец может читать/писать):

```bash
chmod 600 .env
```

### Проверка безопасности

Скрипт `check_secrets.sh` проверяет:
- ✅ Наличие всех секретов
- ✅ Минимальную длину паролей (16+ для Redis, 32+ для Qdrant)
- ✅ Соответствие паролей в URL
- ✅ Безопасные права доступа к файлу

### Рекомендации

1. **Не коммитить .env в git**
   - Файл должен быть в `.gitignore`
   - Используйте `.env.example` как шаблон

2. **Резервное копирование**
   - Храните `.env` в безопасном месте
   - Используйте шифрование для бэкапов

3. **Ротация паролей**
   - Меняйте пароли каждые 90 дней
   - Запускайте `generate_secrets.sh` для генерации новых

4. **Secrets Management**
   - Для production используйте Vault, AWS Secrets Manager и т.д.
   - Не храните секреты в коде или конфигурационных файлах

## Примеры

### Первое развертывание

```bash
# 1. Копирование шаблона
cp .env.example .env

# 2. Указание только внешних ключей
nano .env  # Добавьте OPENAI_API_KEY и другие внешние ключи

# 3. Развертывание (пароли сгенерируются автоматически)
./scripts/deploy.sh prod
```

### Обновление паролей

```bash
# 1. Удалите старые пароли из .env (или оставьте пустыми)
sed -i 's/^REDIS_PASSWORD=.*/REDIS_PASSWORD=/' .env
sed -i 's/^QDRANT_API_KEY=.*/QDRANT_API_KEY=/' .env

# 2. Сгенерируйте новые
./scripts/generate_secrets.sh .env

# 3. Перезапустите контейнеры
docker-compose -f docker-compose.prod.yml restart
```

### Проверка перед развертыванием

```bash
# Проверка безопасности
./scripts/check_secrets.sh .env

# Если все OK, развертывание
./scripts/deploy.sh prod
```

## Устранение неполадок

### Проблема: Пароли не генерируются

**Решение:**
```bash
# Проверьте наличие openssl
which openssl

# Запустите генерацию вручную
./scripts/generate_secrets.sh .env
```

### Проблема: URL не обновляются

**Решение:**
```bash
# Проверьте формат URL в .env
grep REDIS_URL .env

# Запустите генерацию заново
./scripts/generate_secrets.sh .env
```

### Проблема: Контейнеры не подключаются к Redis

**Решение:**
1. Проверьте пароль в `.env`: `grep REDIS_PASSWORD .env`
2. Проверьте URL: `grep REDIS_URL .env`
3. Убедитесь, что пароль совпадает в URL и переменной
4. Перезапустите контейнеры

## Дополнительная информация

- Подробнее о безопасности: `SECURITY.md`
- Руководство по развертыванию: `DEPLOYMENT_GUIDE.md`
- Быстрый старт: `QUICK_DEPLOY.md`

