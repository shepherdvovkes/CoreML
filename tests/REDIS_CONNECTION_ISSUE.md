# Проблема подключения к Redis

## Описание проблемы

При попытке подключения к Redis из Python (redis-py) возникает ошибка:
```
ConnectionResetError: [Errno 54] Connection reset by peer
```

## Диагностика

### Что работает:
- ✅ Redis контейнер запущен и работает
- ✅ TCP соединение устанавливается успешно
- ✅ Команды доходят до Redis (видно в MONITOR)
- ✅ `redis-cli` внутри контейнера работает нормально
- ✅ Порт 6379 открыт и слушает на 0.0.0.0:6379

### Что не работает:
- ❌ Python redis-py не может прочитать ответ от Redis
- ❌ Соединение сбрасывается сразу после отправки команды
- ❌ Проблема воспроизводится с redis-py 7.1.0 и 5.0.1

## Возможные причины

1. **Проблема с сетью Docker на macOS**
   - Docker Desktop использует виртуальную машину
   - Возможна проблема с пробросом портов или обработкой соединений

2. **Проблема совместимости**
   - Redis 7.4.7 может иметь проблемы с некоторыми клиентами
   - Проблема может быть связана с обработкой IPv6/IPv4

3. **Настройки macOS**
   - Возможны ограничения на уровне системы
   - Проблемы с обработкой сокетов

## Решения

### Вариант 1: Использовать моки для тестов
Тесты в `test_cache_integration.py` используют моки и работают нормально.

### Вариант 2: Тестирование через docker exec
Можно запускать тесты внутри контейнера Redis:
```bash
docker exec -it coreml_redis python -m pytest tests/test_redis_connection.py
```

### Вариант 3: Использовать другой порт
Попробовать использовать другой порт для Redis:
```yaml
ports:
  - "6380:6379"
```

### Вариант 4: Проверить настройки Docker Desktop
- Убедиться, что порты правильно проброшены
- Проверить настройки сети Docker Desktop
- Попробовать перезапустить Docker Desktop

## Временное решение

Для разработки и тестирования рекомендуется использовать моки Redis, как это сделано в `test_cache_integration.py`.

## Статус

✅ **ПРОБЛЕМА РЕШЕНА!**

### Решение

Проблема была в настройках проброса портов в `docker-compose.yml`. 

**Изменения:**
```yaml
ports:
  - "127.0.0.1:6379:6379"  # Вместо "6379:6379"
```

**Причина:**
- Проброс порта на `0.0.0.0` (все интерфейсы) на macOS с Docker Desktop вызывал проблемы с IPv6/IPv4
- Явное указание `127.0.0.1` решает проблему совместимости

**Дополнительно:**
- Добавлен `--protected-mode no` в команду Redis для упрощения подключения

### Результат

Все тесты Redis теперь проходят успешно! ✅

