# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ –≤ –∫–ª–∏–µ–Ω—Ç–µ

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É

**–ü—Ä–æ–±–ª–µ–º–∞:**
```dart
final fileName = file.path.split('/').last;
final extension = fileName.split('.').last.toLowerCase();
```

**–†–∏—Å–∫–∏:**
- –ï—Å–ª–∏ –ø—É—Ç—å –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `/`, `split('/')` –≤–µ—Ä–Ω–µ—Ç —Å–ø–∏—Å–æ–∫ —Å –æ–¥–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
- –ï—Å–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `.`, `split('.')` –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ `IndexOutOfBoundsException` –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```dart
final pathParts = file.path.split('/');
final fileName = pathParts.isNotEmpty ? pathParts.last : file.path;

if (fileName.isEmpty) {
  throw FileError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: ${file.path}');
}

final extension = fileName.contains('.') 
    ? fileName.split('.').last.toLowerCase()
    : '';
```

**–§–∞–π–ª—ã:**
- ‚úÖ `flutter_app/lib/services/chat_service.dart` - `uploadDocument()` –∏ `uploadDocuments()`
- ‚úÖ `flutter_app/lib/services/api_client.dart` - `uploadDocument()` –∏ `uploadDocumentsBatch()`

---

### 2. ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–∞ `file.length()`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –º–µ—Ç–æ–¥–µ `uploadDocuments()` —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —á–∏—Ç–∞–ª—Å—è –¥–≤–∞–∂–¥—ã:
1. –ü—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 344)
2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 376)

**–†–∏—Å–∫–∏:**
- –õ–∏—à–Ω–∏–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –µ—Å–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏—Ç—Å—è –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```dart
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
final fileSizes = <File, int>{};
final fileSize = await file.length();
fileSizes[file] = fileSize;

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
final fileSize = fileSizes[file] ?? await file.length();
```

**–§–∞–π–ª:**
- ‚úÖ `flutter_app/lib/services/chat_service.dart` - `uploadDocuments()`

---

### 3. ‚ùå –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```dart
if (docIndex == -1) {
  docIndex = _documents.length - documents.length + i;
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
  if (docIndex < 0 || docIndex >= _documents.length) {
    docIndex = _documents.length - documents.length + i;  // ‚ùå –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  }
}
```

**–†–∏—Å–∫–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É, –∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ `IndexOutOfBoundsException`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ –ø–æ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–∞:
```dart
// –ù–∞—Ö–æ–¥–∏–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ ID –∏–∑ —Å–ø–∏—Å–∫–∞ documents (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
final document = documents[i];
final docIndex = _documents.indexWhere((d) => d.id == document.id);

if (docIndex != -1) {
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
}
```

**–§–∞–π–ª:**
- ‚úÖ `flutter_app/lib/services/chat_service.dart` - `uploadDocuments()`

---

### 4. ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–∏—Å–∫–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –∏–º–µ–Ω–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
```dart
docIndex = _documents.indexWhere(
  (d) => d.name == filename && d.status == DocumentStatus.uploading
);
```

**–†–∏—Å–∫–∏:**
- –ï—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ —É–∂–µ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º `uploading`, –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –Ω–µ —Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
- –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:
```dart
final document = documents[i];
final docIndex = _documents.indexWhere((d) => d.id == document.id);
```

**–§–∞–π–ª:**
- ‚úÖ `flutter_app/lib/services/chat_service.dart` - `uploadDocuments()`

---

### 5. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –º–µ—Ç–æ–¥–µ `uploadDocumentsBatch()` –Ω–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```dart
if (files.isEmpty) {
  throw const FileError('–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –ø—É—Å—Ç');
}
```

**–§–∞–π–ª:**
- ‚úÖ `flutter_app/lib/services/api_client.dart` - `uploadDocumentsBatch()`

---

### 6. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ —Ç–æ—á–∫—É –ø–µ—Ä–µ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```dart
final extension = fileName.contains('.') 
    ? fileName.split('.').last.toLowerCase()
    : '';
if (extension.isEmpty || !AppConfig.supportedFileTypes.contains(extension)) {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
}
```

**–§–∞–π–ª—ã:**
- ‚úÖ `flutter_app/lib/services/chat_service.dart` - `uploadDocument()` –∏ `uploadDocuments()`

---

## ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç—ã–µ –ø—É—Ç–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
- –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —á—Ç–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### 3. –£–ª—É—á—à–µ–Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É ID –≤–º–µ—Å—Ç–æ –∏–Ω–¥–µ–∫—Å–∞
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –º–∞—Å—Å–∏–≤–æ–≤

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- **–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 6
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 6
- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 2
  - `flutter_app/lib/services/api_client.dart`
  - `flutter_app/lib/services/chat_service.dart`

---

## üß™ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

1. **–¢–µ—Å—Ç —Å —Ñ–∞–π–ª–∞–º–∏ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **–¢–µ—Å—Ç —Å –Ω–µ–æ–±—ã—á–Ω—ã–º–∏ –ø—É—Ç—è–º–∏:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –ø—É—Ç–µ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

3. **–¢–µ—Å—Ç —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º —Ñ–∞–π–ª–æ–≤:**
   - –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

4. **–¢–µ—Å—Ç —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏—Å—è –∏–º–µ–Ω–∞–º–∏:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

5. **–¢–µ—Å—Ç —Å –±–æ–ª—å—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–π –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

---

## ‚úÖ –ò—Ç–æ–≥

–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ö–æ–¥ —Å—Ç–∞–ª –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º, –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º. –õ–∏–Ω—Ç–µ—Ä –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫.

